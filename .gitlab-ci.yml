image: christinamariamayr/ingenieurinformatik:latest

pages:
  stage: deploy
  when: manual
  script:
    - rm -rf /tmp/jb public
    - jupyter-book build . --path-output /tmp/jb # fix Docker issue with launch buttons
    - mkdir -p public
    - cp -a /tmp/jb/_build/html/. public/
  artifacts:
    paths:
      - public

pdf:
  stage: deploy
  when: manual
  script:
    - rm -rf /tmp/ct-book
    - mkdir -p /tmp/ct-book
    - cp -R "$CI_PROJECT_DIR"/. /tmp/ct-book/
    - cd /tmp/ct-book
    - |
      find figs -name "*.gif" -print0 | while IFS= read -r -d '' gif; do
        png="${gif%.gif}.png"
        if [ ! -f "$png" ]; then
          convert "${gif}[0]" "$png" && echo "generated: $png"
        fi
      done
    - rm -rf _build  
    - jupyter-book build . --builder pdflatex --latex-engine="pdflatex -interaction=nonstopmode"
    - mkdir -p "$CI_PROJECT_DIR/output"
    - cp _build/latex/book.pdf "$CI_PROJECT_DIR/output/book.pdf"
    - cp _build/latex/book.log "$CI_PROJECT_DIR/output/book.log"

  artifacts:
    paths:
      - $CI_PROJECT_DIR/output/book.pdf
    expire_in: 1 week
